<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>주간보고</title>
    <link rel="stylesheet" th:href="@{/css/style.css}">
</head>
<body>
<div th:replace="~{fragments/nav :: nav}"></div>

<div class="page-wrapper">
    <div class="home-hero">
        <h1>주간보고 작성</h1>
    </div>

    <div class="home-card">
        <div th:if="${copyFrom}" class="badge info" style="margin-bottom:20px; display:block;">이전 보고서를 기반으로 작성합니다. 내용을 수정한 뒤 생성하세요.</div>
        <div th:if="${formError}" class="badge error" style="margin-bottom:20px; display:block;" th:text="${formError}"></div>

        <form th:action="@{/generate}" th:object="${reportRequest}" method="post">
            <div class="form-group">
                <label>사용자</label>
                <div class="user-select-group">
                    <select id="userSelect" th:field="*{userId}" onchange="toggleNewUser(this)">
                        <option value="">-- 사용자 선택 --</option>
                        <option th:each="user : ${users}" th:value="${user.id}"
                                th:text="${user.team != null ? user.name + ' (' + user.team.name + ')' : user.name}"></option>
                        <option value="-1">+ 새 사용자</option>
                    </select>
                    <input type="text" id="newUserInput" th:field="*{userName}"
                           placeholder="새 사용자 이름 입력" class="hidden">
                </div>
            </div>

            <!-- 새 사용자일 때 팀 선택 -->
            <div id="teamSelectGroup" class="form-group hidden">
                <label>소속 팀</label>
                <div class="user-select-group">
                    <select id="teamSelect" th:field="*{teamId}" onchange="toggleNewTeam(this)">
                        <option value="">-- 팀 선택 --</option>
                        <option th:each="team : ${teams}" th:value="${team.id}" th:text="${team.name}"></option>
                        <option value="-1">+ 새 팀</option>
                    </select>
                    <input type="text" id="newTeamInput" th:field="*{newTeamName}"
                           placeholder="새 팀 이름 입력" class="hidden">
                </div>
            </div>

            <div class="form-group">
                <label>업무 기간</label>
                <div class="period-group">
                    <input type="date" id="periodStart" th:field="*{periodStart}">
                    <span class="period-separator">~</span>
                    <input type="date" id="periodEnd" th:field="*{periodEnd}">
                </div>
                <span class="char-counter" style="margin-top:4px; text-align:left;">미입력 시 이번 주 월~금으로 자동 설정됩니다</span>
            </div>

            <div class="form-group">
                <label for="generalTemplateId">보고서 템플릿</label>
                <select id="generalTemplateId" th:field="*{generalTemplateId}">
                    <option value="">기본 템플릿</option>
                    <option th:each="t : ${generalTemplates}" th:value="${t.id}"
                            th:text="${t.name + (t.isDefault() ? ' (기본)' : '')}"></option>
                </select>
            </div>

            <div class="form-group">
                <label for="rawText">업무 내용</label>
                <textarea id="rawText" th:field="*{rawText}" rows="14"
                          placeholder="업무 내용 입력."></textarea>
                <span class="error-text" th:if="${#fields.hasErrors('rawText')}" th:errors="*{rawText}"></span>
                <span id="rawTextCounter" class="char-counter"></span>
            </div>
            <div class="form-submit-row">
                <button type="submit" class="btn-primary">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
                        <path d="M13 10V3L4 14h7v7l9-11h-7z"/>
                    </svg>
                    보고서 생성
                </button>
                <span class="shortcut-hint">Ctrl + Enter</span>
            </div>
        </form>
    </div>
</div>

<div th:replace="~{fragments/loading :: loading}"></div>

<script>
function toggleNewUser(select) {
    var input = document.getElementById('newUserInput');
    var teamGroup = document.getElementById('teamSelectGroup');
    if (select.value === '-1') {
        input.classList.remove('hidden');
        input.focus();
        select.value = '';
        teamGroup.classList.remove('hidden');
    } else {
        input.classList.add('hidden');
        input.value = '';
        teamGroup.classList.add('hidden');
        document.getElementById('teamSelect').value = '';
        document.getElementById('newTeamInput').classList.add('hidden');
        document.getElementById('newTeamInput').value = '';
    }
}
function toggleNewTeam(select) {
    var input = document.getElementById('newTeamInput');
    if (select.value === '-1') {
        input.classList.remove('hidden');
        input.focus();
        select.value = '';
    } else {
        input.classList.add('hidden');
        input.value = '';
    }
}
</script>
<script th:replace="~{fragments/loading :: loading-script}"></script>
<script>
attachLoading('form', '보고서 생성 중...', '주간보고를 작성하고 있습니다. 약 10초 정도 소요됩니다.');
</script>
<script>initCharCounter('rawText', 'rawTextCounter');</script>
<script>
(function() {
    var s = document.getElementById('periodStart');
    var e = document.getElementById('periodEnd');
    if (s && !s.value) {
        var today = new Date();
        var day = today.getDay();
        var mon = new Date(today);
        mon.setDate(today.getDate() - (day === 0 ? 6 : day - 1));
        var fri = new Date(mon);
        fri.setDate(mon.getDate() + 4);
        s.value = mon.toISOString().slice(0,10);
        e.value = fri.toISOString().slice(0,10);
    }
})();
</script>
</body>
</html>
